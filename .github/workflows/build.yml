name: Launcher Build
on:
  push:
    branches: [ master ]

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_ENV
      
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "${{ env.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ env.version }} already exists, will use existing release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag ${{ env.version }} does not exist, will create new release"
          fi
      
      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.version }}
          release_name: release ${{ env.version }}
          draft: false
          prerelease: ${{ contains(env.version, 'beta') || contains(env.version, 'alpha') }}
      
      - name: Get existing release ID
        if: steps.check_tag.outputs.exists == 'true'
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const release = releases.find(r => r.tag_name === '${{ env.version }}');
            if (release) {
              core.setOutput('id', release.id.toString());
              core.setOutput('upload_url', release.upload_url);
            } else {
              // Si le tag existe mais pas la release, on crée la release
              const { data: newRelease } = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: '${{ env.version }}',
                name: 'release ${{ env.version }}',
                draft: false,
                prerelease: ${{ contains(env.version, 'beta') || contains(env.version, 'alpha') }}
              });
              core.setOutput('id', newRelease.id.toString());
              core.setOutput('upload_url', newRelease.upload_url);
            }
      
      - name: Set release outputs for existing release
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "release_id=${{ steps.get_release.outputs.id }}" >> $GITHUB_ENV
          echo "upload_url=${{ steps.get_release.outputs.upload_url }}" >> $GITHUB_ENV

  build-launcher:
    needs: create-release
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-14, ubuntu-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v1

      - name: Get version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_ENV

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: npm ci
        shell: bash

      - name: Build
        env:
          GH_TOKEN: ${{ secrets.github_token }}
        run: npm run build
        shell: bash
      
      - name: List dist files
        run: |
          echo "Fichiers dans dist/:"
          ls -la dist/ || echo "Dossier dist/ non trouvé"
        shell: bash
      
      - name: Get release ID (Windows only)
        if: matrix.os == 'windows-latest'
        id: get_release
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const release = releases.find(r => r.tag_name === '${{ env.version }}');
            if (release) {
              core.setOutput('id', release.id.toString());
              core.setOutput('upload_url', release.upload_url);
              console.log('Release trouvée:', release.id);
            } else {
              core.setFailed('Release non trouvée pour le tag ${{ env.version }}');
            }
      
      - name: Upload Windows artifacts to release
        if: matrix.os == 'windows-latest' && steps.get_release.outputs.id
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const releaseId = '${{ steps.get_release.outputs.id }}';
            const uploadUrl = '${{ steps.get_release.outputs.upload_url }}';
            
            const distDir = 'dist';
            const filesToUpload = [
              'EarthKingdoms-Launcher-win-x64.exe',
              'EarthKingdoms-Launcher-win-x64.exe.blockmap',
              'latest.yml'
            ];
            
            for (const fileName of filesToUpload) {
              const filePath = path.join(distDir, fileName);
              if (fs.existsSync(filePath)) {
                const fileContent = fs.readFileSync(filePath);
                const fileSize = fs.statSync(filePath).size;
                
                console.log(`Upload de ${fileName} (${fileSize} bytes)...`);
                
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: parseInt(releaseId),
                  name: fileName,
                  data: fileContent,
                  headers: {
                    'content-type': fileName.endsWith('.exe') ? 'application/octet-stream' : 
                                   fileName.endsWith('.yml') ? 'text/yaml' : 
                                   'application/octet-stream',
                    'content-length': fileSize
                  }
                });
                
                console.log(`✅ ${fileName} uploadé avec succès`);
              } else {
                console.log(`⚠️ Fichier non trouvé: ${filePath}`);
              }
            }
